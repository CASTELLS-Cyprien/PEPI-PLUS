<div class="flex justify-end p-4" x-data="{ open: false }">
	{% set formToRender = filterForm is defined ? filterForm : (searchForm is defined ? searchForm : null) %}

	{% if formToRender %}
		{{ form_start(formToRender, {'method': 'GET', 'attr': {'class': 'relative w-full'}}) }}
		<div
			class="relative flex items-center">

			{# 1. BARRE DE RECHERCHE PRINCIPALE #}
			{% if formToRender.query is defined %}
				{{ form_widget(formToRender.query, {
                    'attr': {
                        'class': 'block w-full pl-3 pr-10 py-2 border border-gray-300 rounded-md leading-5 bg-white placeholder-gray-400 focus:outline-none focus:ring-1 focus:ring-green-500 focus:border-green-500 sm:text-sm transition-all shadow-sm',
            			'placeholder': 'Rechercher...'
                    }
                }) }}
			{% endif %}

			<div
				class="absolute inset-y-0 right-0 flex items-center pr-3 space-x-2">
				{# Bouton Effacer (Reset rapide) #}
				{% if app.request.query.all|length > 0 %}
					<a href="{{ path(app.request.attributes.get('_route')) }}" class="flex items-center justify-center p-1.5 text-gray-400 hover:text-red-500 transition-colors border-r border-gray-200 pr-2" title="Réinitialiser">
						<twig:ux:icon name="iconoir:cancel" class="w-5 h-5"/>
					</a>
				{% endif %}

				{# Bouton Icône Filtres (si filterForm existe) #}
				{% if filterForm is defined %}
					<button type="button" @click="open = !open" class="p-1 text-gray-400 hover:text-green-600 transition-colors" :class="{ 'text-indigo-green bg-green-50 rounded': open }">
						<twig:ux:icon name="lucide:sliders-horizontal" class="w-5 h-5"/>
					</button>
				{% endif %}

				{# Bouton Loupe (Submit) #}
				<button type="submit" class="p-1 text-gray-400 hover:text-green-600 transition-colors">
					<twig:ux:icon name="mingcute:search-line" class="h-6 w-6"/>
				</button>
			</div>
		</div>

		{# 2. DROPDOWN UNIQUE (S'adapte dynamiquement au formulaire) #}
		{% if filterForm is defined %}
			<div x-show="open" x-transition:enter="transition ease-out duration-200" x-transition:enter-start="opacity-0 translate-y-1 scale-95" x-transition:enter-end="opacity-100 translate-y-0 scale-100" @click.away="open = false" class="absolute right-0 mt-3 w-80 bg-white rounded-xl shadow-2xl border border-gray-100 z-[100] overflow-hidden" style="display: none;">

				<div class="p-4 border-b border-gray-50 bg-gray-50/50">
					<h3 class="text-sm font-semibold text-gray-700">Filtres avancés</h3>
				</div>

				<div
					class="p-4 space-y-4">

					{# FILTRE : STATUT #}
					{% if filterForm.status is defined %}
						<div class="space-y-1.5">
							<label class="block text-[11px] font-bold text-gray-400 uppercase tracking-wider">Statut</label>
							{{ form_widget(filterForm.status, {'attr': {'class': 'w-full rounded-lg border-gray-300 text-sm focus:border-green-500 focus:ring-green-500'}}) }}
						</div>
					{% endif %}

					{# FILTRE : QUANTITÉ MIN (Page Stock) #}
					{% if filterForm.minQuantity is defined %}
						<div class="space-y-1.5">
							<label class="block text-[11px] font-bold text-gray-400 uppercase tracking-wider">Quantité minimum</label>
							{{ form_widget(filterForm.minQuantity, {'attr': {'class': 'w-full rounded-lg border border-gray-300 text-sm'}}) }}
						</div>
					{% endif %}

					{# FILTRE : QUANTITÉ MAX (Page Stock) #}
					{% if filterForm.maxQuantity is defined %}
						<div class="space-y-1.5">
							<label class="block text-[11px] font-bold text-gray-400 uppercase tracking-wider">Quantité maximal</label>
							{{ form_widget(filterForm.maxQuantity, {'attr': {'class': 'w-full rounded-lg border border-gray-300 text-sm'}}) }}
						</div>
					{% endif %}

					{# FILTRE : DATE DE MISE À JOUR (RANGE PICKER) #}
					{% if filterForm.updatedAtRange is defined %}
						<div class="space-y-1.5">
							<label class="block text-[11px] font-bold text-gray-400 uppercase tracking-wider">Mis à jour</label>
							{{ form_widget(filterForm.updatedAtRange, {'attr': {'class': 'w-full rounded-lg border-gray-200 text-sm px-3 py-2 cursor-pointer'}}) }}
							<div class="hidden">
								{{ form_widget(filterForm.updatedAtStart) }}
								{{ form_widget(filterForm.updatedAtEnd) }}
							</div>
						</div>
					{% endif %}

					{# FILTRE : DATE DE CRÉATION (RANGE PICKER) #}
					{% if filterForm.createdAtRange is defined %}
						<div class="space-y-1.5">
							<label class="block text-[11px] font-bold text-gray-400 uppercase tracking-wider">Créé</label>
							{{ form_widget(filterForm.createdAtRange, {'attr': {'class': 'w-full rounded-lg border-gray-200 text-sm px-3 py-2 cursor-pointer'}}) }}
							<div class="hidden">
								{{ form_widget(filterForm.createdAtStart) }}
								{{ form_widget(filterForm.createdAtEnd) }}
							</div>
						</div>
					{% endif %}

					{# ACTIONS DU DROPDOWN #}
					<div class="flex items-center justify-between pt-2">
						<a href="{{ path(app.request.attributes.get('_route')) }}" class="text-xs text-gray-400 hover:text-red-500 font-medium transition-colors">
							Réinitialiser
						</a>
					</div>
				</div>
			</div>
		{% endif %}

		{{ form_end(formToRender) }}
	{% endif %}
</div>


{# Script Flatpickr pour les date range pickers #}
{# Je fait comme ça car impossible de faire fonctionner dans le app.mjs et app.css #}
{% if filterForm is defined and (filterForm.updatedAtRange is defined or filterForm.createdAtRange is defined) %}
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/material_green.css">
 <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
	 <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/fr.js"></script>
	 <script>
	document.addEventListener('DOMContentLoaded', function() {
	    // Configuration pour le champ "Mis à jour"
	    const updatedAtRangeInput = document.getElementById('{{ filterForm.updatedAtRange.vars.id }}');
	    const updatedAtStartInput = document.getElementById('{{ filterForm.updatedAtStart.vars.id }}');
	    const updatedAtEndInput = document.getElementById('{{ filterForm.updatedAtEnd.vars.id }}');
	    
	    if (updatedAtRangeInput) {
	        flatpickr(updatedAtRangeInput, {
	            mode: "range",
	            dateFormat: "d/m/Y",
	            locale: "fr",
	            onChange: function(selectedDates, dateStr, instance) {
	                if (selectedDates.length === 2) {
	                    const formatDate = (date) => {
	                        const year = date.getFullYear();
	                        const month = String(date.getMonth() + 1).padStart(2, '0');
	                        const day = String(date.getDate()).padStart(2, '0');
	                        return `${year}-${month}-${day}`;
	                    };
	                    
	                    updatedAtStartInput.value = formatDate(selectedDates[0]);
	                    updatedAtEndInput.value = formatDate(selectedDates[1]);
	                } else if (selectedDates.length === 0) {
	                    updatedAtStartInput.value = '';
	                    updatedAtEndInput.value = '';
	                }
	            }
	        });
	    }
	
	    // Configuration pour le champ "Créé"
	    const createdAtRangeInput = document.getElementById('{{ filterForm.createdAtRange.vars.id }}');
	    const createdAtStartInput = document.getElementById('{{ filterForm.createdAtStart.vars.id }}');
	    const createdAtEndInput = document.getElementById('{{ filterForm.createdAtEnd.vars.id }}');
	    
	    if (createdAtRangeInput) {
	        flatpickr(createdAtRangeInput, {
	            mode: "range",
	            dateFormat: "d/m/Y",
	            locale: "fr",
	            onChange: function(selectedDates, dateStr, instance) {
	                if (selectedDates.length === 2) {
	                    const formatDate = (date) => {
	                        const year = date.getFullYear();
	                        const month = String(date.getMonth() + 1).padStart(2, '0');
	                        const day = String(date.getDate()).padStart(2, '0');
	                        return `${year}-${month}-${day}`;
	                    };
	                    
	                    createdAtStartInput.value = formatDate(selectedDates[0]);
	                    createdAtEndInput.value = formatDate(selectedDates[1]);
	                } else if (selectedDates.length === 0) {
	                    createdAtStartInput.value = '';
	                    createdAtEndInput.value = '';
	                }
	            }
	        });
	    }
	});
	</script>
{% endif %}
